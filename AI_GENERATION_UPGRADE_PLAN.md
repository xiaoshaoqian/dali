# AI 穿搭生成流升级方案 (AI Generation Flow Upgrade Plan)

**日期**: 2026-01-16
**作者**: Antigravity (Assistant)
**状态**: ✅ 已确认 (Confirmed)

---

## 1. 核心目标 (Core Objectives)

升级现有的 AI 穿搭生成流程，解决生成等待时间长、图文不一致、交互体验生硬等问题。

*   **体验目标**: 实现"零等待感"的流式交互体验。
*   **视觉目标**: 提升识别选择界面的现代感（锚点交互）。
*   **质量目标**: 保证生成图片与用户原图的一致性（Img2Img）。
*   **性能目标**: 利用并发流式处理，将感知延迟降至最低。

---

## 2. 交互体验升级 (UX Upgrade)

### 2.1 识别与选择 (Recognition & Selection)
摒弃传统的矩形框（Bounding Box），采用更现代的**中心锚点**设计。

*   **UI 元素**: 识别到的每件衣物中心显示一个半透明白点。
*   **交互逻辑**:
    *   **点击**: 选中白点，白点变为实心并带有**紫色呼吸光圈**。
    *   **联动**: 选中时，底部单品卡片自动滚动到当前单品。
    *   **防重叠**: 实施最小间距策略，避免锚点过于密集。

### 2.2 生成过程 (Generation Process)
采用 **"三明治流式体验 + UI 过渡"** 策略：

1.  **即时响应**: 点击开始后，屏幕立即显示 **推荐单品清单**（文字打字机效果）。
2.  **无缝过渡**:
    *   在后台生成绘图指令时（约2秒），前端检测到流静止。
    *   **UI 表现**: 文本光标处显示灰色动画 **"💭 AI正在构思搭配理论..."**。
    *   **心理学**: 完美填补技术上的延迟空窗，让用户感觉 AI 在深度思考。
3.  **图文并茂**:
    *   指令生成完毕后，后台触发画图，前台恢复显示 **搭配理论解析**。
    *   图片在后台生成，完成后在前端 **优雅淡入 (Fade-in)**。

---

## 3. 技术架构方案 (Technical Architecture)

### 3.1 视觉分析：一站式调用 (One-Shot Analysis)
*   **模型**: Qwen-VL-Max。
*   **逻辑**: 单次 API 调用，同时获取所有单品的 `坐标`、`类别` 和 `详细视觉描述`。
*   **数据转换**: 后端将检测框转换为中心点 `(x, y)` 传给前端。

### 3.2 核心逻辑：流式触发协议 (Stream Trigger Protocol)

利用 LLM 的流式输出特性实现串行控制、并行执行。

*   **Prompt 结构约定**:
    1.  **第一部分**: `### 推荐单品清单` (用户可见内容)
    2.  **第二部分**: `<draw_prompt>英文绘图指令...</draw_prompt>` (隐藏指令)
    3.  **第三部分**: `### 搭配解析` (用户可见内容)

*   **后端流式解析器 (Stream Parser)**:
    1.  **透传**: 第一部分直接推送到前端 SSE。
    2.  **截获**: 检测到 `<draw_prompt>`，停止推送，进入缓冲模式。
    3.  **触发**: 检测到闭合标签，提取 Prompt，**异步触发 SiliconFlow 图片生成**。
    4.  **恢复**: 丢弃标签，继续推送第三部分内容。

### 3.3 图像生成：图生图 (Img2Img)
*   **模式**: **Image-to-Image**。
*   **输入**:
    *   `Base Image`: 用户上传的原图。
    *   `Prompt`: LLM 生成的搭配描述。
    *   `Strength`: 0.6 (保留原衣特征的关键参数)。
*   **服务商**: **SiliconFlow (硅基流动)**。
    *   **模型**: `black-forest-labs/FLUX.1-schnell` (极速版)。
    *   **备用**: OpenAI DALL-E 3 / ComfyUI (通过适配器模式切换)。

---

## 4. 数据结构变更 (Data Structures)

**搭配方案记录 (Outfit Record)**

```json
{
  "outfit_id": "uuid",
  "original_image_url": "oss://path/to/image.jpg",
  "anchor_point": { "x": 0.5, "y": 0.4 }, // 百分比坐标
  "selected_item": {
    "label": "风衣",
    "visual_desc": "米色长款风衣，羊毛材质..."
  },
  "generated_content": {
    "item_list": ["白色圆领T恤", "黑色阔腿裤"],
    "theory_text": "米色属于暖色系..."
  },
  "generated_image_url": "oss://path/to/gen_image.jpg",
  "created_at": "timestamp"
}
```

---

## 5. 预期管理与容错 (Expectation & Error Handling)

*   **预期管理**: 结果页底部增加文案 **"AI生成示意图，仅供参考"**。
*   **重试机制**: 图片生成失败不影响文字展示，提供"重新生成"按钮。
*   **格式容错**: 后端增加正则兜底，防止 LLM 输出格式错误导致解析失败。
